<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administraci√≥n de Pedidos</title>
  <style>
    body {
      background-color: #fdf6ec;
      color: #ff6f61;
      font-family: sans-serif;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      border: 2px dashed #ff6f61;
      background: transparent;
      color: #ff6f61;
      cursor: pointer;
      border-radius: 6px;
    }

    .switch-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .switch-label input[type="checkbox"] {
      width: 40px;
      height: 20px;
      appearance: none;
      background: #ccc;
      border-radius: 20px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .switch-label input[type="checkbox"]:checked {
      background: #ff6f61;
    }

    .switch-label input[type="checkbox"]::before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      top: 1px;
      left: 1px;
      transition: 0.3s;
    }

    .switch-label input[type="checkbox"]:checked::before {
      transform: translateX(20px);
    }

    input[type="date"] {
      padding: 0.5rem;
      background-color: transparent;
      color: #ff6f61;
      border: 2px solid #ff6f61;
      border-radius: 6px;
    }

    .tabla-bloque {
      margin-bottom: 3rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      border: 1px solid #ff6f61;
      padding: 0.5rem;
      text-align: center;
    }

    th.sortable {
      cursor: pointer;
    }

    .vacio {
      text-align: center;
      color: #999;
      margin-top: 2rem;
    }

    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <h1>Administraci√≥n de Pedidos</h1>

  <div class="top-bar">
    <button onclick="window.location.href='index.html'">üîô Volver</button>
    <label class="switch-label">
      <span>Pedidos habilitados</span>
      <input type="checkbox" id="switchPedidos">
    </label>
  </div>

  <div id="bloques-horarios"></div>

  <h2 style="margin-top: 4rem; text-align: center;">Hist√≥rico de pedidos</h2>
  <div class="top-bar">
    <input type="date" id="fechaFiltro">
    <button onclick="filtrarPorFecha()">Buscar</button>
    <button onclick="cargarHistorico()">Ver todos</button>
  </div>

  <div id="historico-container" class="tabla-bloque"></div>
  <div style="text-align: center;">
    <button onclick="verMasHistorico()">Ver m√°s</button>
  </div>

  <script>
    const switchPedidos = document.getElementById("switchPedidos");

    async function cargarEstado() {
      const res = await fetch('/estado-pedidos');
      const data = await res.json();
      switchPedidos.checked = data.activo;
    }

    async function actualizarEstado() {
      const activo = switchPedidos.checked;
      await fetch('/estado-pedidos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ activo })
      });
    }

    switchPedidos.addEventListener("change", actualizarEstado);

    async function cargarBloqueHorario(tabla, titulo) {
      const res = await fetch(`/pedidos?tabla=${tabla}`);
      const data = await res.json();
      const container = document.getElementById("bloques-horarios");

      const bloque = document.createElement("div");
      bloque.className = "tabla-bloque";

      const idTabla = `tabla-${tabla}`;
      bloque.innerHTML = `
        <h3>${titulo}</h3>
        <button onclick="limpiarTabla('${tabla}')">Limpiar ${titulo}</button>
        <table id="${idTabla}">
          <thead>
            <tr>
              <th class="sortable" onclick="ordenarTabla('${idTabla}', 0)">Nombre</th>
              <th class="sortable" onclick="ordenarTabla('${idTabla}', 1)">Prote√≠na</th>
              <th class="sortable" onclick="ordenarTabla('${idTabla}', 2)">Cobertura</th>
              <th>Vegetal</th>
              <th>Precio</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(p => `<tr>
              <td>${p.nombre_cliente} ${p.apellido_cliente}</td>
              <td>${p.proteina}</td>
              <td>${p.cobertura}</td>
              <td>${p.vegetal}</td>
              <td>$${p.precio}</td>
            </tr>`).join('')}
          </tbody>
        </table>`;

      container.appendChild(bloque);
    }

    function ordenarTabla(idTabla, columna) {
      const tabla = document.getElementById(idTabla);
      const filas = Array.from(tabla.querySelectorAll('tbody tr'));
      const asc = tabla.dataset.orden !== `col${columna}_asc`;

      filas.sort((a, b) => {
        const aTexto = a.cells[columna].textContent.trim().toLowerCase();
        const bTexto = b.cells[columna].textContent.trim().toLowerCase();
        return asc ? aTexto.localeCompare(bTexto) : bTexto.localeCompare(aTexto);
      });

      const tbody = tabla.querySelector('tbody');
      filas.forEach(f => tbody.appendChild(f));

      tabla.dataset.orden = `col${columna}_${asc ? 'asc' : 'desc'}`;
    }

    async function limpiarTabla(tabla) {
      if (!confirm("¬øSeguro que quer√©s limpiar toda la tabla " + tabla + "?")) return;
      await fetch(`/api/limpiar_tabla/${tabla}`, { method: 'DELETE' });
      location.reload();
    }

    let historicoTodos = [];
    let historicoMostrados = 0;

    async function cargarHistorico() {
      const res = await fetch('/pedidos');
      const data = await res.json();
      historicoTodos = agruparPorClienteYFecha(data);
      historicoMostrados = 0;
      document.getElementById("historico-container").innerHTML = "";
      mostrarMasHistorico();
    }

    function agruparPorClienteYFecha(pedidos) {
      const grupos = {};
      pedidos.forEach(p => {
        const key = `${p.nombre_cliente}_${p.apellido_cliente}_${p.fecha?.split("T")[0]}`;
        if (!grupos[key]) grupos[key] = [];
        grupos[key].push(p);
      });
      return Object.values(grupos);
    }

    function mostrarMasHistorico() {
      const container = document.getElementById("historico-container");
      const max = historicoMostrados + 10;
      const mostrar = historicoTodos.slice(historicoMostrados, max);

      mostrar.forEach(grupo => {
        const div = document.createElement("div");
        div.innerHTML = `
          <h4>${grupo[0].nombre_cliente} ${grupo[0].apellido_cliente} (${grupo[0].fecha.split("T")[0]})</h4>
          <ul>
            ${grupo.map(r => `<li>${r.proteina} + ${r.vegetal} + ${r.cobertura} - $${r.precio}</li>`).join('')}
          </ul>
        `;
        container.appendChild(div);
      });

      historicoMostrados += mostrar.length;
    }

    function verMasHistorico() {
      mostrarMasHistorico();
    }

    function filtrarPorFecha() {
      const fecha = document.getElementById("fechaFiltro").value;
      if (!fecha) return cargarHistorico();
      const filtrado = historicoTodos.filter(grupo => grupo[0].fecha.startsWith(fecha));
      const container = document.getElementById("historico-container");
      container.innerHTML = "";
      filtrado.forEach(grupo => {
        const div = document.createElement("div");
        div.innerHTML = `
          <h4>${grupo[0].nombre_cliente} ${grupo[0].apellido_cliente} (${grupo[0].fecha.split("T")[0]})</h4>
          <ul>
            ${grupo.map(r => `<li>${r.proteina} + ${r.vegetal} + ${r.cobertura} - $${r.precio}</li>`).join('')}
          </ul>
        `;
        container.appendChild(div);
      });
    }

    cargarEstado();
    cargarBloqueHorario("horario_19", "Pedidos 19:00");
    cargarBloqueHorario("horario_20", "Pedidos 20:00");
    cargarBloqueHorario("horario_21", "Pedidos 21:00");
    cargarHistorico();
  </script>
</body>
</html>
